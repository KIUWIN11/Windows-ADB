name: Windows VM WIN

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create random password
        id: pass
        shell: powershell
        run: |
          $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*"
          $password = -join ((1..16) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          echo "PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Create user WIN
        shell: powershell
        run: |
          $username = "WIN"
          $password = ConvertTo-SecureString "$env:PASSWORD" -AsPlainText -Force
          New-LocalUser -Name $username -Password $password -FullName "WIN User"
          Add-LocalGroupMember -Group "Administrators" -Member $username

      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Show login info
        run: |
          echo "=============================="
          echo "USERNAME: WIN"
          echo "PASSWORD: $PASSWORD"
          echo "=============================="

      - name: Keep VM alive
        run: |
          ping -t 127.0.0.1
